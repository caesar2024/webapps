<!DOCTYPE html>
<html>

<head>
    <script src="plotly-2.20.0.min.js" charset="utf-8"></script>
    <script src="math.js" charset="utf-8"></script>
    <script src="module.js" charset="utf-8"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="stylesheet.css">
</head>

<body>
    <table style="width:100%">
        <tr>
            <th>
                <p>N<sub>t</sub> = <span id="NValue"></span> cm<sup>3</sup></p>
            </th>
            <th>
                <p>μ</sub> = <span id="muValue"></span> µm</p>
            </th>
            <th>
                <p>CV = σ/μ</sub> = <span id="sigmaValue"></span></p>
            </th>
        </tr>
        <tr>
            <td>
                <div class="slidecontainer">
                    <input type="range" min="10" max="1000" step="10" value="100" class="slider" id="N">
                </div>
            </td>
            <td>
                <div class="slidecontainer">
                    <input type="range" min="10" max="30" step="0.1" value="15" class="slider" id="mu">
                </div>
            </td>
            <td>
                <div class="slidecontainer">
                    <input type="range" min="0.07" max="0.3" step="0.01" value="0.1" class="slider" id="sigma">
                </div>
            </td>
        </tr>
    </table>


    <div id="plot"></div>
    <script>
        var Nslider = document.getElementById("N");
        var Noutput = document.getElementById("NValue");
        var sigmaslider = document.getElementById("sigma");
        var sigmaoutput = document.getElementById("sigmaValue");
        var muslider = document.getElementById("mu");
        var muoutput = document.getElementById("muValue");
        sigmaoutput.innerHTML = sigmaslider.value;
        muoutput.innerHTML = muslider.value;
        Noutput.innerHTML = Nslider.value;


        var Des = lin(500).map(x => x / 10)
        var xes = Des.map(Dμm_to_xg)
        var Ds = vecmul(Des.slice(0,-2) , Des.slice(1,-1)).map(Math.sqrt)
        var xs = vecmul(xes.slice(0,-2) , xes.slice(1,-1)).map(Math.sqrt)
        var dxs = vecsub(xes.slice(1,-1), xes.slice(0,-2))
        var dDs = vecsub(Des.slice(1,-1), Des.slice(0,-2))


        function plotme(n) {
        var mNc = Nslider.value
        var CV  = sigmaslider.value
        var mDg = muslider.value

        var ν = 0.112 / Math.pow(CV,2.0) - 1.0
    
        function rootF(B) {
            let result = xg_to_Dμm((ν + 1) / B) - mDg
            return result
        } 

        var B = newtonsMethod(rootF, 1e4)
        var A = [Ap(1.0, ν, B), ν, B]
        var mX = gamma_drop(A, xs)
        var mD = vecdiv(vecmul(mX , dxs), dDs)
        var pdf = vecmul(mD , dDs)
 
        const arr = [1, 2, 3];
        const modeD = mD.reduce((a, b) => Math.max(a, b), -Infinity);
        const i = mD.reduce((iMax, x, i, arr) => x > arr[iMax] ? i : iMax, 0);
        const stdDiameter = Math.sqrt(vecmul(Ds.map(D => D - mDg).map(x => Math.pow(x, 2.0)),  vecmul(mX, dxs)).reduce((a,b)=>a+b))
        const stdstr = stdDiameter.toFixed(1).toString()
        const str = 'σ=' + stdstr

        var trace1 = {
                x: Ds,
                y: mD.map(x => x * mNc),
                mode: 'lines',
                type: 'line',
                name: 'n(D) ',
                line: {
                    color: 'rgb(0,0,0)',
                    width: 2
                }
            };

            var trace2 = {
                x: [Ds[i] - stdDiameter, Ds[i] + 4*stdDiameter],
                y: [modeD * mNc / 1.6, modeD * mNc / 1.6],
                mode: 'lines',
                type: 'line',
                name: str,
                
            };

            const trace3 = [{"showlegend":true,"mode":"markers","line":{"color":"rgb(0.72, 0.53, 0.04)","width":0.1},"y":[4.3544,5.8709,7.2372,8.8437,10.3153,12.4024,13.9039,15.2102,16.2462,16.6667,16.982,16.967,16.0661,14.9249,12.8228,9.8949,7.1021,3.8288],"type":"line","name":"S1","visible":"legendonly","error_y":{"type":"data","array":[0.7206999999999999,1.0360000000000005,1.1562000000000001,1.4566,1.621599999999999,1.9670000000000005,2.2822999999999993,2.4924999999999997,2.642699999999998,2.6876999999999995,2.852800000000002,2.777700000000003,2.6726000000000028,2.477500000000001,2.1921999999999997,1.6666000000000007,1.2613000000000003,0.7808000000000002],"thickness":1,"arrayminus":[0.7358000000000002,0.9459999999999997,1.2161999999999997,1.4413,1.6366000000000014,1.9368999999999996,2.222200000000001,2.5075000000000003,2.6727000000000025,2.7177999999999987,2.8077999999999985,2.8378999999999994,2.672699999999999,2.5374999999999996,2.072000000000001,1.7266999999999992,1.2912999999999997,0.7057000000000002]},"x":[8.0871,9.592,10.7311,11.6763,12.471,13.1143,13.6723,14.2089,14.6381,15.1112,15.5628,16.0147,16.4676,16.9423,17.4611,18.1743,18.9952,20.5267]},{"showlegend":true,"mode":"markers","line":{"color":"rgb(0.64, 0.71, 0.8)","width":0.1},"y":[2.8979,3.8138,4.7598,5.9308,6.982,8.0781,8.8437,9.8949,10.2852,10.3904,10.7508,10.2852,9.6997,8.6637,7.6726,6.5165,4.6547,2.7477],"type":"line","name":"S2","visible":"legendonly","error_y":{"type":"data","array":[0.5405000000000002,0.7207000000000003,0.8407999999999998,1.1112000000000002,1.3062999999999994,1.426400000000001,1.6367999999999991,1.8168000000000006,1.786900000000001,1.8918999999999997,1.9217999999999993,1.9370000000000012,1.8618000000000006,1.6365999999999996,1.4714999999999998,1.2613000000000003,0.8708,0.5406],"thickness":1,"arrayminus":[0.4504999999999999,0.6606000000000001,0.8709000000000002,1.0508999999999995,1.2162000000000006,1.471499999999999,1.5914000000000001,1.7266999999999992,1.816699999999999,1.8768999999999991,1.9670000000000005,1.9068000000000005,1.8769,1.7418000000000005,1.5164,1.2763,0.8858999999999999,0.49540000000000006]},"x":[8.5406,10.3044,11.6592,12.7555,13.6797,14.4318,15.1411,15.7856,16.3663,16.9472,17.4848,18.0234,18.6481,19.2518,19.963,20.7821,21.7955,23.5408]}]

            var data = [trace1, trace3[0], trace3[1]];

            var layout = {
                title: "",
                showlegend: true,
                uirevision: true,
                xaxis: {
                    title: "Diameter (µm)",
                    type: 'lin',
                    range: [0, 50],
                },
                yaxis: {
                    title: "dN/dD (cm⁻³ μm⁻¹)",
                    // range: [0, 500000]
                },
                margin: {
                    l: 50,
                    r: 50,
                    b: 40,
                    t: 20,
                    pad: 4
                },
                height: 300,
            };

            var config = {
                responsive: true,
                scrollZoom: true,
                staticPlot: false,
                displayModeBar: false
            }

            sigmaoutput.innerHTML = sigmaslider.value;
            muoutput.innerHTML = muslider.value;
            Noutput.innerHTML = Nslider.value;

            return Plotly.react(plot, data, layout, config);
        }

        function sigma_callback() {
            console.log(plotme(Number(sigmaslider.value)));
        }
        sigmaslider.oninput = sigma_callback;

        function N_callback() {
            console.log(plotme(Number(Nslider.value)));
        }
        Nslider.oninput = N_callback;

        function mu_callback() {
            console.log(plotme(Number(muslider.value)));
        }
        muslider.oninput = mu_callback;

        plotme(Number(sigmaslider.value));

    </script>

</body>

</html>